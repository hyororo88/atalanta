<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì¼ë³¸ì–´ â†’ í•œêµ­ì–´ ë²ˆì—­ í…ŒìŠ¤íŠ¸ (ì˜¤í”„ë¼ì¸ Â· ìŒì„±ì…ë ¥)</title>
<!-- ìŠ¤íƒ€ì¼ ìƒëµ (ê¸°ì¡´ê³¼ ë™ì¼) -->
<style>
  :root{
    --green:#22b24b; --red:#ea1f28; --yellow:#ffe600; --ink:#101319; --bg:#fbfcfe;
    --card:#ffffff; --muted:#7a8699; --border:#e5e8ef;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1000px;margin:28px auto;display:grid;grid-template-columns:3fr 1fr;gap:24px;padding:0 16px}
  .board{border:3px solid #000;border-radius:8px;background:var(--card);position:relative;min-height:460px}
  .pad{padding:24px}
  .titleRow{display:flex;align-items:center;gap:16px;margin-bottom:18px}
  .titleBadge{width:64px;height:64px;background:var(--yellow);border-radius:6px;border:2px solid #000;display:grid;place-items:center;font-weight:700}
  .title{font-size:34px;font-weight:900;color:var(--green)}
  .block{border-radius:8px;padding:18px 16px;margin:18px 0;border:2px solid #000}
  .problem{background:var(--green);color:#fff;min-height:88px;display:flex;align-items:center;justify-content:center;
           font-size:26px;font-weight:800;text-align:center}
  .inputBox{background:var(--red);display:grid;gap:12px}
  .inputBox label{color:#fff;font-weight:700}
  .inputRow{display:flex;gap:10px;align-items:center}
  input[type="text"]{flex:1;padding:14px 12px;font-size:20px;border-radius:8px;border:2px solid #000;outline:none}
  button{padding:12px 16px;border-radius:10px;border:2px solid #000;background:#fff;cursor:pointer;font-weight:800}
  button:active{transform:translateY(1px)}
  .muted{color:var(--muted);font-size:13px}
  .side{display:flex;flex-direction:column;gap:16px}
  .legend{border:1px dashed var(--border);border-radius:8px;padding:16px}
  .legendRow{display:flex;align-items:center;gap:12px;margin:10px 0}
  .chip{width:64px;height:64px;border-radius:6px;border:2px solid #000}
  .chip.red{background:var(--red)} .chip.green{background:var(--green)} .chip.yellow{background:var(--yellow)}
  .scoreBox{position:absolute;left:16px;top:16px;display:grid;gap:6px}
  .scoreDot{width:58px;height:58px;background:var(--yellow);border:2px solid #000;border-radius:6px}
  .scoreText{font-weight:900;font-size:18px;color:#d6b800;text-shadow:0 1px 0 #fff}
  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .fileRow{margin-top:6px}
  .bar{height:8px;background:#eef1f7;border-radius:999px;overflow:hidden}
  .bar > span{display:block;height:100%;background:#3b82f6;width:0%}
  .center{text-align:center}
  .hidden{display:none !important}
  .result{
    position:fixed;inset:0;background:rgba(0,0,0,.58);display:none;align-items:center;justify-content:center;padding:20px
  }
  .resultCard{background:#fff;border-radius:12px;border:2px solid #000;max-width:720px;width:100%;padding:18px}
  .resultCard h2{margin:6px 0 8px}
  .table{width:100%;border-collapse:collapse;margin-top:10px}
  .table th,.table td{border:1px solid #e6e8ee;padding:8px;font-size:14px}
  .table th{background:#f6f7fb}
  /* ë§ˆì´í¬ ë²„íŠ¼ ìƒíƒœ */
  #micBtn[aria-pressed="true"]{ background:#ffe6e6; border-color:#ea1f28 }
  @media (max-width:860px){ .wrap{grid-template-columns:1fr} .board{min-height:520px} }
</style>

</head>
<body>
<div class="wrap">
  <!-- ë©”ì¸ ë³´ë“œ -->
  <section class="board" id="board">
    <div class="scoreBox">
      <div class="scoreDot" title="ì ìˆ˜ & ì‹œê°„"></div>
      <div class="scoreText" id="scoreTime">ì ìˆ˜ 0 / 10 Â· 01:30</div>
      <div class="muted" id="progressText">Q 0 / 10</div>
    </div>

    <div class="pad">
      <div class="titleRow">
        <div class="titleBadge" title="ì ìˆ˜Â·ì‹œê°„ í‘œì‹œìš©"></div>
        <div class="title">ìˆ˜í–‰í‰ê°€</div>
      </div>

      <div class="block problem" id="problemBox">CSVë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš” (jp â†’ kr)</div>

      <div class="block inputBox">
        <label for="ans">ì…ë ¥ì°½</label>
        <div class="inputRow">
          <input id="ans" type="text" placeholder="í•œêµ­ì–´ ë²ˆì—­ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off" disabled />
          <button id="submitBtn" disabled>ì œì¶œ</button>
          <button id="passBtn" disabled>íŒ¨ìŠ¤</button>
          <!-- ë§ˆì´í¬ ë²„íŠ¼ & íŒíŠ¸ -->
          <button id="micBtn" type="button" aria-pressed="false" title="ëˆ„ë¥´ê³  ë§í•˜ê¸°(PTT)">ğŸ¤</button>
        </div>
        <div class="flex muted">
          <span id="feedback">ì¤€ë¹„ ì¤‘â€¦</span>
          <span id="micHint" class="muted">ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§í•˜ì„¸ìš”</span>
        </div>
      </div>

      <div class="fileRow flex">
        <input id="file" type="file" accept=".csv" />
        <button id="startBtn" disabled>ì‹œì‘</button>
        <button id="restartBtn" class="hidden">ë‹¤ì‹œí•˜ê¸°</button>
        <span class="muted">CSV í—¤ë”: <b>jp,kr</b> Â· ì—¬ëŸ¬ ì •ë‹µì€ <b>|</b>ë¡œ êµ¬ë¶„</span>
      </div>

      <div class="bar" aria-hidden="true" style="margin-top:10px"><span id="timeBar"></span></div>
    </div>
  </section>

  <!-- ìš°ì¸¡ ë²”ë¡€ & ë„ì›€ë§ -->
  <aside class="side">
    <div class="legend">
      <div class="legendRow"><div class="chip red"></div><div><b>ì…ë ¥ì°½</b></div></div>
      <div class="legendRow"><div class="chip green"></div><div><b>ë¬¸ì œ</b></div></div>
      <div class="legendRow"><div class="chip yellow"></div>
        <div><b>ì ìˆ˜ ë° ì‹œê°„</b><br><span class="muted">ë‚¨ì€ì‹œê°„ Â· í˜„ì¬ì ìˆ˜</span></div>
      </div>
      <hr>
      <div class="flex">
        <button id="downloadSample">ìƒ˜í”Œ CSV</button>
      </div>
      <p class="muted">ì˜¤í”„ë¼ì¸ ë™ì‘ Â· ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ìŒ</p>
    </div>
  </aside>
</div>
<!-- ê²°ê³¼ ëª¨ë‹¬ -->
<div class="result" id="result">
  <div class="resultCard">
    <h2>ê²°ê³¼</h2>
    <p id="finalLine" style="font-weight:700"></p>
    <table class="table" id="wrongTable">
      <thead><tr><th>#</th><th>ë¬¸ì œ(JP)</th><th>ì •ë‹µ(ë“¤)</th><th>ë‚´ ë‹µ</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="center" style="margin-top:12px">
      <button id="closeResult">ë‹«ê¸°</button>
      <button id="restartFromResult">ë‹¤ì‹œí•˜ê¸°</button>
    </div>
  </div>
</div>
<div id="intro" style="
  position:fixed; inset:0; background:rgba(0,0,0,.58);
  display:flex; align-items:center; justify-content:center; padding:20px; z-index:9999;">
  <div style="background:#fff;border:2px solid #000;border-radius:12px;max-width:720px;width:100%;padding:18px">
    <h2 style="margin:6px 0 8px">ë²ˆì—­ í…ŒìŠ¤íŠ¸ ì‹œì‘</h2>
    <p class="muted" style="margin:0 0 12px">CSV í—¤ë”ëŠ” <b>zh,en,ja,ko,vi</b> ì¤‘ 2ê°œ ì´ìƒ í¬í•¨</p>

    <div class="flex" style="gap:12px; align-items:flex-end; flex-wrap:wrap">
      <div>
        <label for="fromLang"><b>ì›ë¬¸(From)</b></label><br>
        <select id="fromLang" style="padding:10px;border:2px solid #000;border-radius:8px">
          <option value="zh">ì¤‘êµ­ì–´(zh)</option>
          <option value="en">ì˜ì–´(en)</option>
          <option value="ja" selected>ì¼ë³¸ì–´(ja)</option>
          <option value="ko">í•œêµ­ì–´(ko)</option>
          <option value="vi">ë² íŠ¸ë‚¨ì–´(vi)</option>
        </select>
      </div>
      <button id="swapLang" type="button" title="ì„œë¡œ ë°”ê¾¸ê¸°">â†”ï¸</button>
      <div>
        <label for="toLang"><b>ë²ˆì—­(To)</b></label><br>
        <select id="toLang" style="padding:10px;border:2px solid #000;border-radius:8px">
          <option value="zh">ì¤‘êµ­ì–´(zh)</option>
          <option value="en">ì˜ì–´(en)</option>
          <option value="ja">ì¼ë³¸ì–´(ja)</option>
          <option value="ko" selected>í•œêµ­ì–´(ko)</option>
          <option value="vi">ë² íŠ¸ë‚¨ì–´(vi)</option>
        </select>
      </div>
      <div style="margin-left:auto">
        <button id="introStart" type="button">ì–¸ì–´ ì„ íƒ ì™„ë£Œ</button>
      </div>
    </div>

    <hr style="margin:14px 0">
    <p class="muted">â€» ì˜ˆì‹œ CSVê°€ í•„ìš”í•˜ë©´ ìš°ì¸¡ â€˜ìƒ˜í”Œ CSVâ€™ë¥¼ ëˆŒëŸ¬ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”(ë©€í‹°í—¤ë” í¬í•¨).</p>
  </div>
</div>
  
  
<script>
// ê¸°ì¡´ ìƒìˆ˜/ìƒíƒœ/í•¨ìˆ˜ ë¶€ë¶„ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
const MAX_QUESTIONS = 10;
const LIMIT_SECONDS = 90; // 1ë¶„ 30ì´ˆ
let pool = [];         // {jp, answers[]}[]
let quiz = [];         // ì¶œì œ ë°°ì—´
let idx = 0;           // í˜„ì¬ ì¸ë±ìŠ¤
let score = 0;
let timer = null;
let left = LIMIT_SECONDS;
let wrongs = [];       // {jp, answers, mine}

const els = {
  problem: document.getElementById('problemBox'),
  ans: document.getElementById('ans'),
  submit: document.getElementById('submitBtn'),
  pass: document.getElementById('passBtn'),
  feedback: document.getElementById('feedback'),
  file: document.getElementById('file'),
  start: document.getElementById('startBtn'),
  restart: document.getElementById('restartBtn'),
  scoreTime: document.getElementById('scoreTime'),
  progressText: document.getElementById('progressText'),
  timeBar: document.getElementById('timeBar'),
  result: document.getElementById('result'),
  wrongBody: document.querySelector('#wrongTable tbody'),
  finalLine: document.getElementById('finalLine'),
  closeResult: document.getElementById('closeResult'),
  restartFromResult: document.getElementById('restartFromResult'),
  downloadSample: document.getElementById('downloadSample'),
  micBtn: document.getElementById('micBtn'),
  micHint: document.getElementById('micHint'),
};

  
  
  
  /* ===== ì–¸ì–´ ìƒíƒœ & ë§¤í•‘ ===== */
let fromLang = 'ja'; // ê¸°ë³¸: ì¼ë³¸ì–´ â†’ í•œêµ­ì–´
let toLang   = 'ko';

const LANG_LABEL = { zh: 'ì¤‘êµ­ì–´', en: 'ì˜ì–´', ja: 'ì¼ë³¸ì–´', ko: 'í•œêµ­ì–´', vi: 'ë² íŠ¸ë‚¨ì–´' };
// ìŒì„± ì¸ì‹ìš© BCP-47 ì½”ë“œ(í•„ìš” ì‹œ ì¡°ì •)
const SR_LOCALE  = { zh: 'zh-CN', en: 'en-US', ja: 'ja-JP', ko: 'ko-KR', vi: 'vi-VN' };

// ì…ë ¥ì°½ placeholder/íŒíŠ¸ ê°±ì‹ 
function applyLangToUI(){
  els.ans.placeholder = `${LANG_LABEL[toLang]} ë²ˆì—­ì„ ì…ë ¥í•˜ì„¸ìš”`;
  els.micHint.textContent = `ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ${LANG_LABEL[toLang]}ë¡œ ë§í•˜ì„¸ìš”`;
}

// ë¬¸ì œ ë°•ìŠ¤ ë¼ë²¨(ì˜µì…˜)
function labelProblemBox(){
  els.problem.setAttribute('title', `ì›ë¬¸(${LANG_LABEL[fromLang]})`);
}
  
  /* ===== ì¸íŠ¸ë¡œ ì œì–´ ===== */
const introEl = document.getElementById('intro');
const fromSel = document.getElementById('fromLang');
const toSel   = document.getElementById('toLang');
const swapBtn = document.getElementById('swapLang');
const introStartBtn = document.getElementById('introStart');

swapBtn.addEventListener('click', ()=>{
  const f = fromSel.value, t = toSel.value;
  fromSel.value = t; toSel.value = f;
});

introStartBtn.addEventListener('click', ()=>{
  if(fromSel.value === toSel.value){
    alert('ì›ë¬¸ê³¼ ë²ˆì—­ ì–¸ì–´ê°€ ê°™ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  fromLang = fromSel.value; toLang = toSel.value;
  introEl.style.display = 'none';
  applyLangToUI();
  labelProblemBox();
});
  
/* ===================== ìœ í‹¸ ===================== */
// ê°„ë‹¨ CSV íŒŒì„œ(ë”°ì˜´í‘œ ì²˜ë¦¬ ì§€ì›, CRLF/ë¹ˆì¤„ ì œì™¸)
function parseCSV(text){
  const rows = [];
  let i=0, field='', row=[], inQuotes=false;
  for(; i<text.length; i++){
    const c = text[i], n = text[i+1];
    if(inQuotes){
      if(c === '"' && n === '"'){ field+='"'; i++; }
      else if(c === '"'){ inQuotes = false; }
      else field += c;
    }else{
      if(c === '"'){ inQuotes = true; }
      else if(c === ','){ row.push(field); field=''; }
      else if(c === '\n'){
        row.push(field); field='';
        if(row.length>1 || (row.length===1 && row[0].trim()!=="")) rows.push(row.map(v=>v.replace(/\r/g,'')));
        row=[];
      }else field += c;
    }
  }
  if(field!=='' || row.length){ row.push(field); rows.push(row.map(v=>v.replace(/\r/g,''))); }
  return rows;
}
// ì •ë‹µ ë¹„êµ(ê³µë°±/ì¼ë¶€ ë¬¸ì¥ë¶€í˜¸/ê´„í˜¸ ì œê±°, ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
function normalize(s){
  return (s||'')
    .toString()
    .trim()
    .toLowerCase()
    .replace(/[(),.!?]/g,'')
    .replace(/\s+/g,' ');
}
function isCorrect(input, answers){
  const mine = normalize(input);
  return answers.some(a => normalize(a) === mine);
}
// ì…”í”Œ
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j = (Math.random()* (i+1))|0; [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function updateTop(){
  els.scoreTime.textContent = `ì ìˆ˜ ${score} / 10 Â· ${String(Math.floor(left/60)).padStart(2,'0')}:${String(left%60).padStart(2,'0')}`;
  els.progressText.textContent = `Q ${Math.min(idx,MAX_QUESTIONS)} / ${MAX_QUESTIONS}`;
  els.timeBar.style.width = `${100*(LIMIT_SECONDS-left)/LIMIT_SECONDS}%`;
}
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ===================== íŒŒì¼ ì¸ì½”ë”© ì²˜ë¦¬ ===================== */
// íŒŒì¼ì„ UTF-8ë¡œ ë¨¼ì €, ê¹¨ì§(ï¿½)ì´ ë³´ì´ë©´ EUC-KRë¡œ ì¬ë””ì½”ë”© + BOM ì œê±°
async function readCsvFile(file){
  const buf = await file.arrayBuffer();
  const u8  = new Uint8Array(buf);
  // 1ì°¨: UTF-8
  let text  = new TextDecoder('utf-8', {fatal:false}).decode(u8);
  // BOM ì œê±°
  if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

  // ê¹¨ì§ ìˆìœ¼ë©´ EUC-KR ì¬ì‹œë„
  if (text.includes('ï¿½')) {
    try {
      let t2 = new TextDecoder('euc-kr').decode(u8);
      if (t2.charCodeAt(0) === 0xFEFF) t2 = t2.slice(1);
      text = t2;
    } catch(e){}
  }
  return text;
}

/* ===================== ë¡œë”©/ì‹œì‘ ===================== */
els.file.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if(!f){ els.start.disabled = true; return; }
  const txt = await readCsvFile(f);
  const rows = parseCSV(txt);
  if(!rows.length){ alert('CSVë¥¼ ì½ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); els.start.disabled = true; return; }

  // ë‹¤êµ­ì–´ í—¤ë” ì§€ì›: zh,en,ja,ko,vi ì¤‘ ë“¤ì–´ìˆëŠ” ì—´ì„ ì‹ë³„
  const header = rows[0].map(h=>h.trim().toLowerCase());
  const langs  = ['zh','en','ja','ko','vi'];
  const colIdx = Object.fromEntries(langs.map(l=>[l, header.indexOf(l)]));

  if(colIdx[fromLang] < 0 || colIdx[toLang] < 0){
    alert(`CSVì— í•„ìš”í•œ í—¤ë”ê°€ ì—†ìŠµë‹ˆë‹¤. (í•„ìˆ˜: ${fromLang}, ${toLang})`);
    els.start.disabled = true;
    return;
  }

  pool = rows.slice(1)
    .filter(r => r[colIdx[fromLang]] && r[colIdx[toLang]])
    .map(r=>{
      const src = (r[colIdx[fromLang]]||'').trim();
      const tgt = (r[colIdx[toLang]]||'').trim();
      const answers = tgt.split('|').map(s=>s.trim()).filter(Boolean);
      return { jp: src, answers };        // ê¸°ì¡´ í•„ë“œëª… jp ì¬ì‚¬ìš©(í‘œì‹œ í…ìŠ¤íŠ¸ìš©)
    });

  if(pool.length===0){
    alert('ìœ íš¨í•œ ë¬¸ì œ í–‰ì´ ì—†ìŠµë‹ˆë‹¤.');
    els.start.disabled = true;
    return;
  }
  els.start.disabled = false;
  els.feedback.textContent = `ë¡œë“œ ì™„ë£Œ: ${pool.length}ë¬¸í•­ Â· ì‹œì‘ì„ ëˆ„ë¥´ì„¸ìš” (From ${LANG_LABEL[fromLang]} â†’ To ${LANG_LABEL[toLang]})`;
});

els.start.addEventListener('click', startGame);
els.restart.addEventListener('click', startGame);

function startGame(){
  wrongs = []; score = 0; idx = 0; left = LIMIT_SECONDS;
  quiz = shuffle(pool.slice()).slice(0, MAX_QUESTIONS);
  enableInput(true);
  nextQuestion();
  if(timer) clearInterval(timer);
  timer = setInterval(()=>{
    left--;
    updateTop();
    if(left<=0){ timeUp(); }
  },1000);
  els.restart.classList.add('hidden');
}

function enableInput(on){
  els.ans.disabled = els.submit.disabled = els.pass.disabled = !on;
  toggleMicAvailability();
  if(on){ els.ans.focus(); els.ans.select(); }
}

/* ===================== ì§„í–‰ ===================== */
function nextQuestion(){
  if(idx>=quiz.length){ finish(); return; }
  const q = quiz[idx];
  els.problem.textContent = q.jp;
  els.ans.value = '';
  els.feedback.textContent = `ë²ˆì—­ì„ ì…ë ¥í•˜ê³  [ì œì¶œ] ë˜ëŠ” [íŒ¨ìŠ¤]`;
  updateTop();
}

els.submit.addEventListener('click', ()=>{
  if(idx>=quiz.length) return;
  const mine = els.ans.value.trim();
  if(mine===''){ els.feedback.textContent='ì…ë ¥ì„ í™•ì¸í•˜ì„¸ìš”.'; els.ans.focus(); return; }
  const q = quiz[idx];
  const ok = isCorrect(mine, q.answers);
  if(ok){
    score++;
    els.feedback.textContent = 'ì •ë‹µ!';
  }else{
    wrongs.push({jp:q.jp, answers:q.answers, mine});
    els.feedback.textContent = `ì˜¤ë‹µ! ì •ë‹µ: ${q.answers.join(' / ')}`;
  }
  idx++;
  setTimeout(nextQuestion, 450);
});

els.pass.addEventListener('click', ()=>{
  if(idx>=quiz.length) return;
  const q = quiz[idx];
  wrongs.push({jp:q.jp, answers:q.answers, mine:'(íŒ¨ìŠ¤)'});
  els.feedback.textContent = `íŒ¨ìŠ¤! ì •ë‹µ: ${q.answers.join(' / ')}`;
  idx++;
  setTimeout(nextQuestion, 300);
});

/* ===================== ì¢…ë£Œ ===================== */
function timeUp(){
  clearInterval(timer); timer=null;
  enableInput(false);
  els.feedback.textContent='ì‹œê°„ ì¢…ë£Œ!';
  finish();
}
function finish(){
  clearInterval(timer); timer=null;
  enableInput(false);
  els.restart.classList.remove('hidden');
  els.finalLine.textContent = `ìµœì¢… ì ìˆ˜: ${score} / ${MAX_QUESTIONS} (ë‚¨ì€ì‹œê°„ ${Math.max(left,0)}ì´ˆ)`;
  els.wrongBody.innerHTML = '';
  if(wrongs.length===0){
    els.wrongBody.innerHTML = '<tr><td colspan="4" class="center">ì˜¤ë‹µ ì—†ìŒ ğŸ‰</td></tr>';
  }else{
    wrongs.forEach((w,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(w.jp)}</td><td>${escapeHtml(w.answers.join(' / '))}</td><td>${escapeHtml(w.mine)}</td>`;
      els.wrongBody.appendChild(tr);
    });
  }
  els.result.style.display='flex';
  updateTop();
}
els.closeResult.onclick = ()=> els.result.style.display='none';
els.restartFromResult.onclick = ()=>{ els.result.style.display='none'; 
                                     applyLangToUI();
labelProblemBox();

                                     
                                     startGame(); };

/* ===================== ìƒ˜í”Œ CSV (BOM í¬í•¨) ===================== */
/* ===================== ìƒ˜í”Œ CSV (BOM í¬í•¨, ë‹¤êµ­ì–´ í—¤ë”) ===================== */
/* ===================== ìƒ˜í”Œ CSV (BOM í¬í•¨, ë‹¤êµ­ì–´ í—¤ë”/ì¤„ë°”ê¿ˆ) ===================== */
els.downloadSample.addEventListener('click', ()=>{
  // í–‰ ë°°ì—´(5ê°œ ì»¬ëŸ¼ ê³ ì •: zh,en,ja,ko,vi)
  const rows = [
    ['zh','en','ja','ko','vi'],
    ['æ—©ä¸Šå¥½','Good morning','ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™','ì¢‹ì€ ì•„ì¹¨ì…ë‹ˆë‹¤|ì•ˆë…•í•˜ì„¸ìš”','ChÃ o buá»•i sÃ¡ng'],
    ['è°¢è°¢','Thank you','ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™','ê°ì‚¬í•©ë‹ˆë‹¤|ê³ ë§™ìŠµë‹ˆë‹¤','Cáº£m Æ¡n báº¡n'],
    ['å¯¹ä¸èµ·','Sorry','ã™ã¿ã¾ã›ã‚“','ì£„ì†¡í•©ë‹ˆë‹¤|ì‹¤ë¡€í•©ë‹ˆë‹¤','Xin lá»—i'],
    ['æ˜¯','Yes','ã¯ã„','ë„¤','VÃ¢ng'],
    ['ä¸æ˜¯','No','ã„ã„ãˆ','ì•„ë‹ˆìš”','KhÃ´ng'],
    ['æ‹œæ‰˜äº†','Please','ãŠé¡˜ã„ã—ã¾ã™','ë¶€íƒí•©ë‹ˆë‹¤|ì œë°œìš”','LÃ m Æ¡n'],
    ['åŠ æ²¹','Good luck','é ‘å¼µã£ã¦ãã ã•ã„','í˜ë‚´ì„¸ìš”|í™”ì´íŒ…','Cá»‘ lÃªn'],
    ['è¾›è‹¦äº†','Good work','ãŠç–²ã‚Œæ§˜ã§ã™','ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤|ìˆ˜ê³ ìš”','Báº¡n váº¥t váº£ rá»“i'],
    ['æˆ‘ä»¬èµ°å§','Letâ€™s go','è¡Œãã¾ã—ã‚‡ã†','ê°‘ì‹œë‹¤|ê°€ìš”','Äi thÃ´i']
  ];

  // CSV ì§ë ¬í™” (í•„ìš”ì‹œ ë”°ì˜´í‘œ ì²˜ë¦¬)
  const esc = (s)=> {
    const t = String(s ?? '');
    return /[",\r\n]/.test(t) ? `"${t.replace(/"/g,'""')}"` : t;
  };
  const csv = rows.map(r => r.map(esc).join(',')).join('\r\n');

  const BOM = '\uFEFF'; // ì‹¤ì œ BOM ë¬¸ì
  const blob = new Blob([BOM + csv], { type:'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'sample_multilang.csv';
  document.body.appendChild(a);
  a.click(); a.remove();
});

// === ìˆ˜ì •ëœ ë§ˆì´í¬ ìŠ¤í¬ë¦½íŠ¸ ===
(function(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition || null;
  const micBtn = els.micBtn;
  const hint   = els.micHint;
  const input  = els.ans;
  const submit = els.submit;

  if(!SR){
    micBtn.disabled = true;
    hint.textContent = 'ì´ ê¸°ê¸°/ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„± ì¸ì‹ APIê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
    return;
  }

  let rec = null, stopping = false, autoSubmitTimer = null;

  function makeRec(){
    const r = new SR();
    r.lang = SR_LOCALE[toLang] || 'ko-KR';

    r.interimResults = true;
    r.continuous = false;
    r.maxAlternatives = 1;
    r.onstart = () => {
      micBtn.setAttribute('aria-pressed','true');
      hint.textContent = 'ë§ì”€í•˜ì„¸ìš”â€¦';
    };
    r.onresult = (e) => {
      const res = e.results[e.results.length - 1];
      const txt = res[0].transcript.trim();
      input.value = txt;
      clearTimeout(autoSubmitTimer);
      if(res.isFinal){
        autoSubmitTimer = setTimeout(()=> submit.click(), 1000);
      }
    };
    r.onend = () => {
      micBtn.setAttribute('aria-pressed','false');
      hint.textContent = 'ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§í•˜ì„¸ìš”';
      stopping = false;
    };
    r.onerror = (e) => {
      console.error('SpeechRecognition error', e);
      hint.textContent = 'ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ' + (e.error || 'ì•Œ ìˆ˜ ì—†ìŒ');
      micBtn.setAttribute('aria-pressed','false');
    };
    return r;
  }

  micBtn.addEventListener('click', ()=>{
    if(input.disabled) return;
    const on = micBtn.getAttribute('aria-pressed') === 'true';
    if(on) {
      if(rec) rec.abort();
      stopping = true;
    } else {
      rec = makeRec();
      try {
        rec.start();
      } catch(e){
        console.error('rec.start ì‹¤íŒ¨', e);
        hint.textContent = 'ìŒì„± ì¸ì‹ ì‹œì‘ ì‹¤íŒ¨';
      }
    }
  });

  // ë§ˆì´í¬ ìŠ¤í¬ë¦½íŠ¸ ë§ˆì§€ë§‰ ë¶€ë¶„ì€ ì´ë ‡ê²Œ ëë‚˜ì•¼ í•©ë‹ˆë‹¤.
window.toggleMicAvailability = function(){
  micBtn.disabled = input.disabled;
  if (input.disabled) {
    micBtn.setAttribute('aria-pressed','false');
    if (rec) rec.abort();
  }
};
  // === Enterë¡œ ì œì¶œ: ì…ë ¥ê¸°(IME) ì¡°í•© ì¤‘ì—ëŠ” ë¬´ì‹œ, ì‹œì‘ ì „ì—ëŠ” ë¬´ì‹œ ===
els.ans.addEventListener('keydown', (e) => {
  // í•œê¸€/ì¼ë³¸ì–´ ë“± IME ì¡°í•© ì¤‘ì—ëŠ” Enterê°€ ë“¤ì–´ì™€ë„ ì œì¶œí•˜ì§€ ì•ŠìŒ
  if (e.isComposing) return;

  if (e.key === 'Enter') {
    e.preventDefault();
    // ê²Œì„ ì‹œì‘ ì „(ë²„íŠ¼ ë¹„í™œì„±)ì—ëŠ” ë¬´ì‹œ
    if (els.submit.disabled) return;
    els.submit.click();
  }
});
  
})(<!-- ì¸íŠ¸ë¡œ ì˜¤ë²„ë ˆì´ -->
);
</script>
</body>
</html>
